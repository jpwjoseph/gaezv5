---
title: "Getting Started with gaezv5"
author: "Julian Joseph"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with gaezv5}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE,
  purl = FALSE
)
```

## Introduction

The `gaezv5` package provides comprehensive tools for downloading, processing, and analyzing Global Agro-Ecological Zones (GAEZ) version 5 data from the International Institute for Applied Systems Analysis (IIASA) and the Food and Agriculture Organization (FAO).

This vignette covers the main features including data discovery, URL building, downloading, country-level cropping, and batch processing.

## What is GAEZ v5?

GAEZ v5 provides comprehensive global data on:

-   **Agricultural potential** and crop suitability
-   **Attainable and actual** crop yields
-   **Agro-climatic resources** (temperature, precipitation, growing periods)
-   **Land and water resources**
-   **Yield and production gaps**

The data is available at high spatial resolution (\~9km) and includes:

-   Historical periods (1981-2000, 2001-2020)
-   Future projections (2021-2100) under different climate scenarios
-   Multiple input levels (high/low) and water management systems (irrigated/rainfed)
-   Over 60 crop types

## Installation

Install from GitHub:

``` r
# install.packages("devtools")
devtools::install_github("jpwjoseph/gaezv5")
library(gaezv5)
library(terra)  # For raster operations
```

------------------------------------------------------------------------

## Core Workflow: Discovery & Lookup

### 1. List Available Crops

Browse available crops in GAEZ v5 (this works without internet access):

```{r eval=TRUE}
library(gaezv5)

# List all available crops (theme 4 = attainable yield)
list_gaez_crops(theme = 4)
```

```{r eval=TRUE}
# Filter to cereals only
list_gaez_crops(crop_group = "cereal", theme = 4)
```

### 2. Browse All Variables

Explore available variables:

```{r eval=TRUE}
# Get all variables
get_gaez_variables()
```

### 3. List Time Periods & Scenarios

See available time periods, climate models, and scenarios:

```{r eval=TRUE}
# List available time periods
list_gaez_scenarios(type = "time_period")
```

```{r eval=TRUE}
# List climate models
list_gaez_scenarios(type = "climate_model")
```

```{r eval=TRUE}
# List SSP scenarios
list_gaez_scenarios(type = "ssp")
```

### 4. Look Up Specific Codes

Find exact codes using lookup functions (no internet required):

```{r eval=TRUE}
# Look up crop by name (returns code)
lookup_gaez_crop("maize", theme = 4)
```

```{r eval=TRUE}
# Look up variable
lookup_gaez_variable("attainable yield")
```

### 5. Validate Parameter Combinations

Check if parameter combinations are valid:

```{r eval=TRUE}
# Validate historical period (requires AGERA5 + HIST)
validation <- validate_climate_ssp("HP0120", NULL, "SSP370")
print(validation$climate_model)  # Will auto-correct to AGERA5
print(validation$ssp)             # Will auto-correct to HIST
```

```{r eval=TRUE}
# Validate future period (requires GCM + future SSP)
validation <- validate_climate_ssp("FP4160", "ENSEMBLE", "SSP370")
print(validation)
```

------------------------------------------------------------------------

## Building URLs (Works Locally)

Once you know what you want to download, build a URL:

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Build a download URL
url <- build_gaez_url(
  variable = "RES05-YX",
  crop = "MZE",
  time_period = "HP0120",
  climate_model = "AGERA5",
  ssp = "HIST"
)
print(url)

# Check if URL exists
exists <- check_url_exists(url)
print(paste("URL exists:", exists))
```

------------------------------------------------------------------------

## Downloading Data (Requires Internet)

The following functions require internet access to Google Cloud Storage and will only work when NOT_CRAN is set:

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Load maize yield data (automatically downloads if needed)
maize <- load_gaez_data(
  crop = "MZE",
  time_period = "HP0120",
  climate_model = "AGERA5"
)

terra::plot(maize, main = "Global Maize Attainable Yield (2001-2020)")
```

### Load Country-Level Data

Reduce file sizes dramatically by cropping to country boundaries:

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Load Niger maize data (much smaller than global)
niger_maize <- load_gaez_data(
  crop = "MZE",
  time_period = "HP0120",
  country = "Niger"
)

terra::plot(niger_maize, main = "Niger Maize Yield")
# File size comparison: Global ~800 MB → Niger ~8 MB (100x reduction!)
```

### Interactive Map Preview

Preview data without downloading full datasets:

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Interactive leaflet map preview (no full download needed!)
preview_gaez_map(
  variable = "RES05-YX",
  crop = "wheat",
  time_period = "FP4160",
  ssp = "SSP370"
)
```

### Batch Download Multiple Datasets

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Download multiple crops efficiently
results <- batch_download_gaez_datasets(
  crops = c("MZE", "WHE", "SOR"),
  time_period = "HP0120",
  climate_model = "AGERA5",
  verbose = FALSE
)

# Check success rate
success_count <- sum(sapply(results, function(x) x$success))
print(paste(success_count, "out of", length(results), "downloads succeeded"))
```

### Combine Batch Results

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Download time series
time_results <- batch_download_gaez_datasets(
  crops = "MZE",
  time_periods = c("HP0120", "FP4160", "FP6180"),
  parallel = FALSE,
  verbose = FALSE
)

# Combine into single multi-layer raster
timeseries <- combine_gaez_batch(time_results)
print(timeseries)  # Shows 3 layers
```

------------------------------------------------------------------------

## Common Use Cases

### Historical vs Future Comparison

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Load historical
hist <- load_gaez_data(
  crop = "WHE",
  time_period = "HP0120",
  climate_model = "AGERA5"
)

# Load future
future <- load_gaez_data(
  crop = "WHE",
  time_period = "FP4160",
  climate_model = "ENSEMBLE",
  ssp = "SSP370"
)

# Calculate change
change <- future - hist
plot(change, main = "Wheat Yield Change: 2041-2060 vs 2001-2020")
```

### Scenario Comparison

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Download multiple scenarios
scenario_results <- batch_download_gaez_datasets(
  crops = "MZE",
  time_period = "FP4160",
  ssps = c("SSP126", "SSP370", "SSP585"),  # Low, medium, high emissions
  parallel = FALSE
)

# Combine with custom names
scenarios <- combine_gaez_batch(
  scenario_results,
  layer_names = c("Low_emissions", "Medium_emissions", "High_emissions")
)

# Compare scenarios
plot(scenarios)
```

### Country-Level Analysis

```{r eval=identical(Sys.getenv("NOT_CRAN"), "true")}
# Download for multiple countries
countries <- c("Niger", "Nigeria", "Burkina Faso")
country_data <- list()

for (country in countries) {
  country_data[[country]] <- load_gaez_data(
    crop = "SOR",
    time_period = "FP4160",
    country = country,
    verbose = FALSE
  )
}

# Calculate mean yields
mean_yields <- sapply(country_data, function(r) {
  global(r, "mean", na.rm = TRUE)[[1]]
})

# Plot comparison
barplot(mean_yields, main = "Sorghum Yield by Country",
        ylab = "Yield (kg/ha)", las = 2, col = "lightblue")
```

------------------------------------------------------------------------

## Understanding GAEZ Codes

### Time Periods

| Code   | Period    | Description         |
|--------|-----------|---------------------|
| HP8100 | 1981-2000 | Historical baseline |
| HP0120 | 2001-2020 | Recent historical   |
| FP2140 | 2021-2040 | Near future         |
| FP4160 | 2041-2060 | Mid-century         |
| FP6180 | 2061-2080 | Late century        |
| FP8100 | 2081-2100 | End of century      |

### Climate Models

-   **AGERA5**: Historical periods only (reanalysis data)
-   **ENSEMBLE**: Multi-model mean (recommended for future)
-   Individual GCMs: GFDL-ESM4, IPSL-CM6A-LR, MPI-ESM1-2-HR, MRI-ESM2-0, UKESM1-0-LL

### SSP Scenarios

-   **HIST**: Historical scenario
-   **SSP126**: Low emissions (Paris Agreement, \~1.5-2°C)
-   **SSP370**: Medium emissions (current policies, \~3-4°C)
-   **SSP585**: High emissions (worst case, \~4-5°C)

### Water Management

| Code | Description                           |
|------|---------------------------------------|
| HRLM | High input, Rainfed, Low management   |
| HILM | High input, Irrigated, Low management |
| LRLM | Low input, Rainfed, Low management    |
| LILM | Low input, Irrigated, Low management  |

### Common Crop Codes (Theme 4)

| Code | Crop         | Code | Crop    |
|------|--------------|------|---------|
| MZE  | Maize        | WHE  | Wheat   |
| RIC  | Rice         | SOR  | Sorghum |
| PMI  | Pearl millet | COW  | Cowpea  |
| SUN  | Sunflower    | SOY  | Soybean |

------------------------------------------------------------------------

## Getting Help

```{r eval=TRUE}
# View examples
show_gaez_examples()
```

```{r eval=FALSE}
# Function help
?load_gaez_data
?download_gaez_dataset
?combine_gaez_batch
?preview_gaez_map

# Browse all documentation
help(package = "gaezv5")
```

------------------------------------------------------------------------

## Further Reading

-   [GAEZ v5 Portal](https://gaez.fao.org/)
-   [Package GitHub](https://github.com/jpwjoseph/gaezv5)
-   [Report Issues](https://github.com/jpwjoseph/gaezv5/issues)

------------------------------------------------------------------------

**Package Version**: 0.2.0 \| **Last Updated**: `r Sys.Date()`